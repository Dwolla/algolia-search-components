{"version":3,"file":"index.mjs","sources":["../src/templates.tsx","../src/AlgoliaAutocomplete.tsx","../src/utils/debouncePromise.ts","../src/utils/computeIndexName.ts"],"sourcesContent":["import type { AutocompleteComponents, VNode } from \"@algolia/autocomplete-js\";\nimport type { Hit } from \"@algolia/client-search\";\nimport type { AlgoliaRecord } from \"./types\";\n\nexport const TEMPLATES = {\n  item: (hit: AlgoliaRecord, components: AutocompleteComponents): JSX.Element => {\n    return (\n      <a href={hit.url}>\n        <div className=\"aa-ItemContent\">\n          <div className=\"aa-ItemIcon\">\n            <svg width=\"20\" height=\"20\" viewBox=\"0 0 20 20\">\n              <path\n                d=\"M17 6v12c0 .52-.2 1-1 1H4c-.7 0-1-.33-1-1V2c0-.55.42-1 1-1h8l5 5zM14 8h-3.13c-.51 0-.87-.34-.87-.87V4\"\n                stroke=\"currentColor\"\n                fill=\"none\"\n                fillRule=\"evenodd\"\n                strokeLinejoin=\"round\"\n              />\n            </svg>\n          </div>\n          <div>\n            <div className=\"aa-ItemTitle\">\n              {hit.hierarchy?.lvl0 ?? <components.Highlight hit={hit} attribute=\"title\" />}\n            </div>\n            {hit.hierarchy && <div className=\"aa-ItemHierarchy\">{hierarchyToBreadcrumbs(hit, components)}</div>}\n            <div className=\"aa-ItemDescription\">{getSuggestionSnippet(hit, components)}</div>\n          </div>\n        </div>\n      </a>\n    );\n  },\n\n  poweredBy: (): VNode => {\n    return (\n      <div className=\"aa-powered-by\">\n        Search by\n        <a href=\"https://www.algolia.com/\" className=\"aa-powered-by-link\">\n          Algolia\n        </a>\n      </div>\n    );\n  }\n};\n\n/**\n * Transform a highlighted hierarchy object into an array of Highlighted elements.\n * 3 levels max are returned.\n *\n * @param hit - A record with a hierarchy field ( { lvl0: string, lvl1: string, lvl2: string, ... } ).\n * @param components - Autocomplete components.\n * @returns An array of JSX.Elements | string, representing of the highlighted hierarchy starting from lvl1.\n *          Between each element, we insert a ' > ' character to render them as breadcrumbs eventually.\n */\nfunction hierarchyToBreadcrumbs(\n  hit: Hit<AlgoliaRecord>,\n  components: AutocompleteComponents\n): Array<JSX.Element | string> {\n  const breadcrumbArray: Array<JSX.Element | string> = [];\n  let addedLevels = 0;\n  if (!hit.hierarchy) {\n    return breadcrumbArray;\n  }\n  for (let i = 1; i < 7 && addedLevels < 3; ++i) {\n    const lvl = `lvl${i}`;\n    if (hit.hierarchy[lvl] && hit.hierarchy[lvl].length > 0) {\n      if (addedLevels > 0) {\n        breadcrumbArray.push(\" > \");\n      }\n      breadcrumbArray.push(<components.Highlight hit={hit.hierarchy} attribute={lvl} />);\n      ++addedLevels;\n    }\n  }\n  return breadcrumbArray;\n}\n\nfunction getSuggestionSnippet(hit: Hit<AlgoliaRecord>, components: AutocompleteComponents): JSX.Element | string {\n  // If they are defined as `searchableAttributes`, 'description' and 'content' are always\n  // present in the `_snippetResult`, even if they don't match.\n  // So we need to have 1 check on the presence and 1 check on the match\n  const description = hit._snippetResult?.description;\n  const content = hit._snippetResult?.content;\n\n  // Take in priority props that matches the search\n  if (description && description.matchLevel === \"full\") {\n    return <components.Snippet hit={hit} attribute=\"description\" />;\n  }\n  if (content && content.matchLevel === \"full\") {\n    return <components.Snippet hit={hit} attribute=\"content\" />;\n  }\n\n  // Otherwise take the prop that was at least correctly returned\n  if (description && !content) {\n    return <components.Snippet hit={hit} attribute=\"description\" />;\n  }\n  if (content) {\n    return <components.Snippet hit={hit} attribute=\"content\" />;\n  }\n\n  // Otherwise raw value or empty\n  return hit.description || hit.content || \"\";\n}\n","import type { AutocompleteOptions, AutocompleteSource, SourceTemplates } from \"@algolia/autocomplete-js\";\nimport { autocomplete, getAlgoliaResults } from \"@algolia/autocomplete-js\";\nimport type { HighlightedHit } from \"@algolia/autocomplete-preset-algolia\";\nimport type { SearchOptions } from \"@algolia/client-search\";\nimport type { SearchClient } from \"algoliasearch/lite\";\nimport type { FC } from \"react\";\nimport { createElement, Fragment, useEffect, useRef } from \"react\";\nimport type { Root } from \"react-dom/client\";\nimport { createRoot } from \"react-dom/client\";\nimport type { AlgoliaRecord } from \"./types\";\nimport { TEMPLATES } from \"./templates\";\nimport computeIndexName from \"./utils/computeIndexName\";\nimport debouncePromise from \"./utils/debouncePromise\";\n\nimport \"./index.scss\";\n\nexport interface AlgoliaAutocompleteProps extends Partial<AutocompleteOptions<AlgoliaRecord>> {\n  branch: string;\n  debounceTimeout?: number;\n  searchClient: SearchClient;\n  searchOptions?: SearchOptions;\n  siteId: string;\n}\n\ntype AlgoliaSource = AutocompleteSource<HighlightedHit<AlgoliaRecord>>;\n\nconst getSources = (\n  searchClient: SearchClient,\n  indexName: string,\n  params?: SearchOptions,\n  debounceTimeout?: number\n): Promise<AlgoliaSource> => {\n  const templates: SourceTemplates<HighlightedHit<AlgoliaRecord>> = {\n    header: () => \"\",\n    item: ({ item, components }) => TEMPLATES.item(item, components),\n    footer: () => TEMPLATES.poweredBy()\n  };\n\n  return tryDebounce(\n    {\n      sourceId: \"algoliaHits\",\n      getItems: ({ query }) => {\n        return getAlgoliaResults({\n          searchClient,\n          queries: [{ indexName, query, params }]\n        });\n      },\n      getItemUrl: ({ item }) => item.url,\n      templates\n    },\n    debounceTimeout\n  );\n};\n\nconst tryDebounce = async (items: AlgoliaSource, time?: number): Promise<AlgoliaSource> =>\n  new Promise<AlgoliaSource>((resolve) =>\n    time ? debouncePromise((items) => resolve(items), time)(items) : resolve(items)\n  );\n\nconst AlgoliaAutocomplete: FC<AlgoliaAutocompleteProps> = (props) => {\n  const containerRef = useRef<HTMLDivElement | null>(null);\n  const panelRootRef = useRef<Root | null>(null);\n  const rootRef = useRef<HTMLElement | null>(null);\n\n  useEffect(() => {\n    if (!containerRef.current) return undefined;\n\n    const search = autocomplete<AlgoliaRecord>({\n      autoFocus: false,\n      container: containerRef.current,\n      getSources: async () => [\n        await getSources(\n          props.searchClient,\n          computeIndexName(props.branch, props.siteId),\n          props.searchOptions,\n          props.debounceTimeout\n        )\n      ],\n      panelPlacement: \"input-wrapper-width\",\n      placeholder: \"Search...\",\n      render: ({ children }, root) => {\n        if (!panelRootRef.current || rootRef.current !== root) {\n          rootRef.current = root;\n\n          panelRootRef.current?.unmount();\n          panelRootRef.current = createRoot(root);\n        }\n        panelRootRef.current?.render(children);\n      },\n      renderer: {\n        createElement,\n        Fragment,\n        // eslint-disable-next-line @typescript-eslint/no-empty-function\n        render: () => {}\n      },\n      ...props\n    });\n\n    return () => search?.destroy();\n  }, [props]);\n\n  return <div ref={containerRef} />;\n};\n\nexport default AlgoliaAutocomplete;\n","export default function <A extends any[], R>(fn: (...args: A) => R, time: number) {\n  let timerId: NodeJS.Timeout | undefined;\n\n  return function (...args: A) {\n    if (timerId) clearTimeout(timerId);\n\n    return new Promise((resolve) => {\n      timerId = setTimeout(() => resolve(fn(...args)), time);\n    });\n  };\n}\n","export default function (branch: string, siteId: string): string {\n  // Keep in sync with crawler code in /netlify/crawl\n  const cleanBranch = branch\n    .trim()\n    .replace(/[^\\p{L}\\p{N}_.-]+/gu, \"-\")\n    .replace(/-{2,}/g, \"-\")\n    .toLocaleLowerCase();\n  return `netlify_${siteId}_${cleanBranch}_all`;\n}\n"],"names":["TEMPLATES","hit","components","_jsx","Object","assign","href","url","children","_jsxs","className","width","height","viewBox","d","stroke","fill","fillRule","strokeLinejoin","_b","_a","hierarchy","lvl0","Highlight","attribute","hierarchyToBreadcrumbs","getSuggestionSnippet","breadcrumbArray","addedLevels","i","lvl","length","push","description","_snippetResult","content","matchLevel","Snippet","tryDebounce","items","time","__awaiter","Promise","resolve","fn","timerId","args","clearTimeout","setTimeout","debouncePromise","AlgoliaAutocomplete","props","containerRef","useRef","panelRootRef","rootRef","useEffect","current","search","autocomplete","autoFocus","container","getSources","searchClient","branch","siteId","indexName","trim","replace","toLocaleLowerCase","params","searchOptions","debounceTimeout","sourceId","getItems","query","getAlgoliaResults","queries","getItemUrl","item","templates","header","footer","panelPlacement","placeholder","render","root","unmount","createRoot","renderer","createElement","Fragment","destroy","ref"],"mappings":"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"}